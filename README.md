# Assembler. Транслятор и модель

- Мокров Семён Андреевич, гр. Р33121
- `asm | risc | neum | hw | tick | struct | stream | mem | prob5`

## Язык программирования

``` ebnf
program ::= line "\n" program

line ::= label
       | variable
       | comment
       | command
       | section

label ::= "." name ":"

variable ::= name ":"

comment ::= ; <any sequence>

command ::= "\t" operation_2_args " " operand ", " operand |
            "\t" operation_1_arg " " operand |
            "\t" operation_0_args |

section ::= "section ." section_name

section_name ::= "text" | "data"

operation_2_args ::= "ADD" | "SUB" | "MOV" | "DIV" | "MOD" | "CMP" | "LD" | "ST" | "MUL"

operation_1_arg ::= "JMP" | "JE" | "JNE" | "JG" | "INC" | "DEC"

operation_0_args ::= "HLT"

operand ::= %r1 | .label | #var | (var) | char | number    ; var here is variable in memory, 
                                                           ; # and () - address mode

char ::= [a-z]
          
number ::= [-2^64; 2^64 - 1]

```

Поддерживаемые аргументы:

- **регистр** - `%r1`. Всего регистров 5: r1, r2, r3, r4, r5.
- **объявленная метка** - `.<label>:`.
- **адрес памяти** - `#1`. Рекомендуется использовать **только**
  с зарезервированными переменными. **Нельзя** использовать с именами объявленных переменных
- **объявленная переменная** - `(NAME)`. Переменная обязательно должна находиться в скобках.
- **символ** - `'a'`. Транслируется в код ASCII. **Нельзя** указывать несколько символов сразу (строки не поддерживаются). Символ обязательно должен находиться в одинарных кавычках
- **целое число** в диапазоне [-2^64 ; 2^64 - 1].


Виды операций:

- **регистровая** операция - может использовать в качестве операндов регистры или значения: символ, число
- операция **перехода** - может поддерживать метки в качестве операндов
- операция **по работе с памятью** - может поддерживать адреса и имена переменных в качестве операндов
- часть операций может иметь свои ограничения на операнды (или может не иметь операндов вовсе)


Код находится в `section .text` и выполняется последовательно. Операции:

- `ADD <arg1> <arg2>` -- прибавить ко второму аргументу первый. *Регистровая операция*.
- `SUB <arg1> <arg2>` -- вычесть из второго аргумента первый. *Регистровая операция*
- `MOV <arg1> <arg2>` -- скопировать значение из первого аргумента во второй. *Регистровая операция* 
- `DIV <arg1> <arg2>` -- получить целую часть от деления первого аргумента на второй. *Регистровая операция*
- `MOD <arg1> <arg2>` -- получить остаток от деления первого аргумента на второй. *Регистровая операция*
- `MUL <arg1> <arg2>` -- получить произведение первого аргумента на второй. *Регистровая операция*
- `CMP <arg1> <arg2>` -- получить результат сравнения первого аргумента со вторым (0, если аргументы равны). *Регистровая операция*
- `INC <arg>` -- инкрементировать операнд (+1). Может иметь в качестве операнда только регистр. *Регистровая операция*
- `DEC <arg>` -- декрементировать (-1) операнд. Может иметь в качестве операнда только регистр. *Регистровая операция*
- `LD <arg1> <arg2>` -- загрузить в 1 операнд 2. 2 операндом может выступать только адрес или имя ячейки, 1 операндом может выступать только регистр. *Регистровая операция* и операция *по работе с памятью*
- `ST <arg1> <arg2>` -- загрузить в 2 операнд 1. 1 операндом может выступать только адрес или имя ячейки, 2 операндом может выступать только регистр. *Регистровая операция* и операция *по работе с памятью*
- `JE <label>` -- если результат предыдущей операции равен 0, перейти на аргумент-метку. *Операция перехода*
- `JNE <label>` -- если результат предыдущей операции не равен 0, перейти на аргумент-метку. *Операция перехода*
- `JG <label>` -- если результат предыдущей операции больше 0, перейти на аргумент-метку переход на аргумент-метку. *Операция перехода*
- `JMP <label>` -- безусловный переход на аргумент-метку. *Операция перехода*
- `HLT` -- завершить выполнение программы

Переменные объявляются в `section .data` и имеют следующий синтаксис - `<VAR>: <value>`:
- `<VAR>` - имя переменной. При обращении к нему необходимо учитывать регистр. Имя не должно иметь пробелов и должно заканчиваться символом `:`
- `<value>` - значение переменной. Может быть числом или символом (`'a'`). Правила записи те же, что и для аргументов.
- Одна переменная должна располагаться на 1 строчке.
- Не имеют фиксированного адреса  памяти.

Дополнительные конструкции:

- `; <any sequence not containing ';'>` - комментарий
- `section .text` - объявление секции кода
- `section .data` - объявление секции данных
- `.<label>:` - метки для переходов / названия переменных. Могут быть объявлены только в `section .text`. Должны располагаться на отдельной строчке

Зарезервированные переменные:
  - Имеют фиксированный адрес в памяти
  - Возможно обратиться только напрямую через адрес в памяти (#STDIN)
  - При трансляции превращаются в их адрес
  - Виды:
    - ```STDIN``` - при чтении переменной происходит ввод данных. В переменную нельзя записывать.
    - ``STDOUT`` - при записи в переменную происходит вывод данных. Из переменной нельзя читать.


Примечания:

- Результаты операций с 2 аргументами (если он есть) помещаются в 1 аргумент
- Должен присутствовать `section .text` - тело программы
- Должна присутствовать метка `.start:` в `section .text` - точка входа в программу
- При обращении к необъявленной метке или переменной возникнет ошибка.
- Все составляющие языка **регистрозависимы**

## Транслятор

Интерфейс командной строки: `translator.py <input_file> <target_file>"`

Реализовано в модуле: [translator](./src/translation/translator.py)

Этапы трансляции (функция `translate`):

1. Препроцессирование исходного кода: удаление лишних пробелов, запятых, комментариев. Реализовано в функции `preprocessing` модуля [preprocessor](./src/translation/preprocessor.py)
2. Проверка наличия метки `.start`
3. Преобразование `section .text` в машинный код (с учетом ограничений) - функция `parse_text`
4. Преобразование `section .data` в машинный код (с учетом ограничений) - функция `parse_data`
5. Объединение машинных кодов двух секций и определение адресов переменных внутри команд - функция `join_text_and_data`
6. Установка стартового адреса программы (с учетом смещения относительно данных и зарезервированных ячеек) - функция `add_start_address`

Правила генерации машинного кода:

- один `Operation` (класс, описывающий операцию) -- одна инструкция;
- в начале каждой программы стоит команда `jmp`, которая указывает на стартовый адрес
- вместо регистров подставляются их имена (экземпляры enum `Register`)
- вместо адресов в памяти подставляются сами адреса или адреса зарезервированных ячеек (если они используются)
- вместо переменных подставляется смещение относительно адреса, следующего после команды,
- вместо меток подставляется смещение относительно адреса, следующего после команды, до следующих после них ячеек в памяти
- вместо символов подставляются их ASCII коды
- числа остаются числами